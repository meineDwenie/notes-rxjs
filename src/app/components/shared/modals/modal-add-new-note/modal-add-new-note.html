<div class="modal-background">
  <div
    class="modal-container"
    clickOutside
    (clickOutside)="close.emit()"
    (click)="$event.stopPropagation()"
    [style.backgroundColor]="noteColor"
  >
    <!-- Hidden file input -->
    <input
      #fileInput
      type="file"
      accept="image/*"
      multiple
      style="display: none"
      (change)="onImageSelected($event)"
    />

    <!-- Note Title and Content -->
    <div class="header">
      <input
        type="text"
        [(ngModel)]="noteTitle"
        class="title-input"
        placeholder="Note Title"
        (keyup.enter)="addNote()"
        (keyup.esc)="close.emit()"
      />

      <textarea
        #noteTextArea
        placeholder="Take a note..."
        autoResize
        [(ngModel)]="noteContent"
        (keyup.esc)="close.emit()"
      ></textarea>
    </div>

    <!-- Image Preview with Loading States -->
    <div class="image-preview" *ngIf="selectedImages.length > 0">
      <div
        class="image-wrapper"
        *ngFor="let imgObj of selectedImages; let i = index"
      >
        <div class="image-container">
          <!-- Loading indicator -->
          <div *ngIf="imgObj.loading" class="loading-indicator">Loading...</div>

          <!-- Image (only visible when lodaded) -->
          <img
            *ngIf="!imgObj.loading && imgObj.data"
            [src]="imgObj.data"
            class="preview-thumbnail"
            (click)="openImage(imgObj.data)"
            style="cursor: zoom-in"
            alt="Preview image"
          />
        </div>
        
        <!-- Remove button -->
        <button
          class="remove-image-button"
          (click)="removeSelectedImage(i)"
          *ngIf="!imgObj.loading"
          title="Remove image"
        >
          Ã—
        </button>
      </div>
    </div>

    <!-- Loading status indicator -->
    <div *ngIf="loadingImagesCount > 0" class="loading-status">
      <small
        >Loading {{ loadingImagesCount }} image{{ loadingImagesCount > 1 ? 's' :
        '' }}...</small
      >
    </div>

    <!-- Fullscreen Image Preview Overlay -->
    <div class="image-overlay" *ngIf="selectedImage" (click)="closeImage()">
      <img
        [src]="selectedImage"
        class="full-image"
        (click)="$event.stopPropagation()"
      />

      <button class="close-overlay" (click)="closeImage()">&times;</button>
    </div>

    <div class="pin-icon">
      <i
        class="bi"
        [ngClass]="notePinned ? 'bi-pin-fill' : 'bi-pin'"
        [title]="notePinned ? 'Unpin' : 'Pin'"
        (click)="togglePin()"
      ></i>
    </div>

    <!-- Color Picker -->
    <div class="color-picker">
      <label *ngFor="let c of availableColors">
        <input
          type="radio"
          name="noteColor"
          [value]="c"
          [(ngModel)]="noteColor"
        />
        <span [style.backgroundColor]="c" class="color-swatch"></span>
      </label>
    </div>

    <!-- Buttons -->
    <div class="buttons-container" (click)="$event.stopPropagation()">
      <div class="left-buttons">
        <app-button-feature
          customClass="image-button"
          icon="cuida:image-outline"
          title="Upload image"
          (clicked)="triggerImageUpload()"
        ></app-button-feature>

        <app-button-feature
          customClass="archive-button"
          icon="mage:archive"
          title="Archive note"
        ></app-button-feature>

        <app-button-feature
          customClass="reminder-button"
          icon="carbon:reminder"
          title="Add reminder"
        ></app-button-feature>

        <!-- <app-button-feature
          customClass="add-to-notebook-button"
          icon="fluent:notebook-arrow-curve-down-20-regular"
          title="Add to notebook"
          (clicked)="openAddToNotebookModal(getNoteForEmit())"
        ></app-button-feature> -->
      </div>
    </div>

    <!-- <button (click)="addNote()" class="add-note-button">Add Note</button> -->

    <!-- Add Note Button - Show loading state when images are still loading -->
    <button
      (click)="addNote()"
      class="add-note-button"
      [disabled]="!allImagesLoaded && selectedImages.length > 0"
      [title]="!allImagesLoaded && selectedImages.length > 0 ? 'Please wait for images to finish loading' : 'Add Note'"
    >
      <span *ngIf="allImagesLoaded || selectedImages.length === 0"
        >Add Note</span
      >
      <span *ngIf="!allImagesLoaded && selectedImages.length > 0">
        <span class="button-spinner"></span>
        Processing Images...
      </span>
    </button>
  </div>
</div>
