<div class="modal-background">
  <div
    class="modal-container"
    clickOutside
    (clickOutside)="close.emit()"
    (click)="$event.stopPropagation()"
    [style.backgroundColor]="noteColor"
  >
    <!-- Hidden file input -->
    <input
      #fileInput
      type="file"
      accept="image/*"
      multiple
      style="display: none"
      (change)="onImageSelected($event)"
    />

    <!-- Note Title and Content -->
    <div class="header">
      <input
        type="text"
        [(ngModel)]="noteTitle"
        class="title-input"
        placeholder="Note Title"
        (keyup.enter)="addNote()"
        (keyup.esc)="close.emit()"
      />

      <textarea
        #noteTextArea
        placeholder="Take a note..."
        autoResize
        [(ngModel)]="noteContent"
        (keyup.esc)="close.emit()"
      ></textarea>
    </div>

    <!-- Image Preview with Loading States -->
    @if (selectedImages.length > 0) {
    <div class="image-preview">
      @for (imgObj of selectedImages; track $index; let i = $index) {
      <div class="image-wrapper">
        <div class="image-container">
          <!-- Loading indicator -->
          @if (imgObj.loading) {
          <div class="loading-indicator">Loading...</div>
          }

          <!-- Image (only visible when loaded) -->
          @if (!imgObj.loading && imgObj.data) {
          <img
            [src]="imgObj.data"
            class="preview-thumbnail"
            (click)="openImage(imgObj.data)"
            style="cursor: zoom-in"
            alt="Preview image"
          />
          }
        </div>

        <!-- Remove button -->
        @if (!imgObj.loading) {
        <button
          class="remove-image-button"
          (click)="removeSelectedImage(i)"
          title="Remove image"
        >
          Ã—
        </button>
        }
      </div>
      }
    </div>
    }

    <!-- Loading status indicator -->
    @if (loadingImagesCount > 0) {
    <div class="loading-status">
      <small>
        Loading {{ loadingImagesCount }} image{{ loadingImagesCount > 1 ? 's' :
        '' }}...
      </small>
    </div>
    }

    <!-- Fullscreen Image Preview Overlay -->
    @if (selectedImage) {
    <div class="image-overlay" (click)="closeImage()">
      <img
        [src]="selectedImage"
        class="full-image"
        (click)="$event.stopPropagation()"
      />

      <button class="close-overlay" (click)="closeImage()">&times;</button>
    </div>
    }

    <div class="pin-icon">
      <i
        class="bi"
        [ngClass]="notePinned ? 'bi-pin-fill' : 'bi-pin'"
        [title]="notePinned ? 'Unpin' : 'Pin'"
        (click)="togglePin()"
      ></i>
    </div>

    <!-- Color Picker -->
    <div class="color-picker">
      @for (c of availableColors; track c) {
      <label>
        <input
          type="radio"
          name="noteColor"
          [value]="c"
          [(ngModel)]="noteColor"
        />
        <span [style.backgroundColor]="c" class="color-swatch"></span>
      </label>
      }
    </div>

    <!-- Buttons -->
    <div class="buttons-container" (click)="$event.stopPropagation()">
      <div class="left-buttons">
        <app-button-feature
          customClass="image-button"
          icon="cuida:image-outline"
          title="Upload image"
          (clicked)="triggerImageUpload()"
        ></app-button-feature>

        <app-button-feature
          customClass="archive-button"
          icon="mage:archive"
          title="Archive note"
        ></app-button-feature>

        <app-button-feature
          customClass="reminder-button"
          icon="carbon:reminder"
          title="Add reminder"
        ></app-button-feature>
      </div>
    </div>

    <!-- Add Note Button - Show loading state when images are still loading -->
    <button
      (click)="addNote()"
      class="add-note-button"
      [disabled]="!allImagesLoaded && selectedImages.length > 0"
      [title]="!allImagesLoaded && selectedImages.length > 0 ? 'Please wait for images to finish loading' : 'Add Note'"
    >
      @if (allImagesLoaded || selectedImages.length === 0) {
      <span>Add Note</span>
      } @else {
      <span>
        <span class="button-spinner"></span>
        Processing Images...
      </span>
      }
    </button>
  </div>
</div>
