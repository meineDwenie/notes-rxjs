<!-- Edit Mode -->
<div class="modal-overlay" (mousedown)="onBackgroundClick()">
  <div class="modal-content" (mousedown)="$event.stopPropagation()">
    <input
      type="text"
      [ngModel]="title"
      (ngModelChange)="titleChange.emit($event)"
      class="title-input"
      (keyup.enter)="save.emit()"
      (keyup.esc)="cancel.emit()"
      #titleInput
    />

    <!-- Toggle between checkboxes and regular content -->
    <div class="content-mode-toggle">
      <button
        type="button"
        (click)="toggleCheckboxMode()"
        class="mode-toggle-btn"
        [class.active]="showCheckboxes"
      >
        <i class="mode-icon">{{ showCheckboxes ? "üìù" : "‚òëÔ∏è" }}</i>
        {{ showCheckboxes ? "Switch to Text" : "Switch to Checkboxes" }}
      </button>
    </div>

    <!-- Checkboxes Mode -->
    @if (showCheckboxes) {
    <app-draggable-checkboxes
      [checkboxes]="localCheckboxes"
      (checkboxesChange)="onCheckboxesChanged($event)"
    ></app-draggable-checkboxes>
    }

    <!-- Regular Text Mode -->
    @if (!showCheckboxes) {
    <textarea
      autoResize
      [ngModel]="content"
      (ngModelChange)="contentChange.emit($event)"
      class="modal-textarea"
      placeholder="Edit your note"
      (keyup.esc)="cancel.emit()"
      #textAreaInput
    ></textarea>
    }

    <!-- Image Previews -->
    <div class="image-preview">
      @for (img of images; track $index; let i = $index) {
      <div class="image-wrapper">
        @if (imageLoading[i]) {
        <div class="spinner"></div>
        }

        <img
          [src]="img"
          class="preview-thumbnail"
          (load)="imageLoad.emit(i)"
          [style.display]="imageLoading[i] ? 'none' : 'block'"
          (click)="openImage(img)"
          style="cursor: zoom-in"
        />

        <!-- Fullscreen Image Preview Overlay -->
        @if (selectedImage) {
        <div class="image-overlay" (click)="closeImage()">
          <img
            [src]="selectedImage"
            class="full-image"
            (click)="$event.stopPropagation()"
          />

          <button class="close-overlay" (click)="closeImage()">&times;</button>
        </div>
        }

        <button
          (click)="removeImage.emit(i); $event.stopPropagation()"
          class="remove-image-button"
        >
          &times;
        </button>
      </div>
      }
    </div>

    <!-- Color Picker -->
    <div class="color-picker">
      @for (c of availableColors; track c) {
      <label>
        <input
          type="radio"
          name="modalNoteColor"
          [value]="c"
          [checked]="c === color"
          (change)="colorChange.emit(c)"
        />
        <span [style.backgroundColor]="c" class="color-swatch"></span>
      </label>
      }
    </div>

    <!-- Hidden file input for uploading images -->
    <input
      #modalImageInput
      type="file"
      accept="image/*"
      multiple
      style="display: none"
      (change)="onFilesSelected($event)"
    />

    <!-- Action Buttons -->
    <div class="buttons-container">
      <div class="note-tools">
        <app-button-feature
          customClass="image-button"
          icon="mage:image"
          title="Upload image"
          (clicked)="triggerImageUpload($event)"
        ></app-button-feature>

        <app-button-feature
          customClass="reminder-button"
          icon="carbon:reminder"
          title="Add reminder"
        ></app-button-feature>

        <app-button-feature
          customClass="add-checkboxes-button"
          icon="tabler:checkbox"
          title="Add checkboxes"
          (clicked)="onAddCheckboxes()"
        ></app-button-feature>
      </div>

      <div class="save-cancel-buttons">
        <button (click)="cancel.emit()" class="buttons-container-cancel">
          Cancel
        </button>
        <button (click)="save.emit()" class="buttons-container-save">
          Save
        </button>
      </div>
    </div>
  </div>
</div>
