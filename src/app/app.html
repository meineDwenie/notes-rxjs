<div class="app-layout">
  <!-- LEFT PANEL - Sidebar ---------------------------------------->
  <app-sidebar [appTitle]="'Noteboard'"></app-sidebar>

  <!-- Header ------------------------------------------------------>
  <app-header
    (createNote)="openNewNoteModal()"
    (createNotebook)="openCreateNotebookModal()"
    [searchTerm]="searchTerm"
    [viewMode]="viewMode"
    [activeFilters]="activeFilters"
    (searchChange)="onSearchChange($event)"
    (filterRemove)="removeFilter($event)"
  ></app-header>

  <!-- RIGHT PANEL - Main Content ---------------------------------->
  <div class="main-content">
    <!-- Router Outlet for different views -->
    <router-outlet></router-outlet>
  </div>

  <!-- MODALS ------------------------------------------------------->
  <!-- Note Modal -->
  <div class="note-modal" *ngIf="selectedNote" (click)="closeNoteModal()">
    <div
      class="modal-content"
      (click)="$event.stopPropagation()"
      [style.backgroundColor]="isModalEditing ? modalColor : selectedNote.color || '#ffffff'"
    >
      <!-- View mode -->
      <div *ngIf="!isModalEditing" class="modal-view">
        <h3 (click)="enableModalEdit()">{{ selectedNote.title }}</h3>
        <div class="modal-scrollable-content" (click)="enableModalEdit()">
          <p>{{ selectedNote.content }}</p>
        </div>
        <div class="image-preview">
          <div
            class="image-wrapper"
            *ngFor="let img of modalImages; let i = index"
          >
            <img [src]="img" class="preview-thumbnail" />
          </div>
        </div>
        <div class="modal-footer-buttons">
          <button (click)="deleteNote(selectedNote.id)">
            <i class="bi bi-trash-fill"></i> Delete
          </button>
          <button class="close-btn" (click)="closeNoteModal()">Close</button>
        </div>
      </div>

      <!-- Edit mode -->
      <div *ngIf="isModalEditing">
        <input type="text" [(ngModel)]="modalTitle" class="title-input" />
        <textarea
          autoResize
          [(ngModel)]="modalContent"
          class="modal-textarea"
          placeholder="Edit your note"
        ></textarea>
        <div class="image-preview">
          <div
            class="image-wrapper"
            *ngFor="let img of modalImages; let i = index"
          >
            <div class="spinner" *ngIf="modalImageLoading[i]"></div>
            <img
              [src]="img"
              class="preview-thumbnail"
              (load)="onImageLoad(i)"
              [style.display]="modalImageLoading[i] ? 'none' : 'block'"
            />
            <button
              (click)="removeModalImage(i); $event.stopPropagation()"
              class="remove-image-button"
            >
              &times;
            </button>
          </div>
        </div>
        <div class="color-picker">
          <label *ngFor="let c of availableColors">
            <input
              type="radio"
              name="modalNoteColor"
              [value]="c"
              [(ngModel)]="modalColor"
            />
            <span [style.backgroundColor]="c" class="color-swatch"></span>
          </label>
        </div>
        <div class="buttons-container">
          <div class="image-upload-container">
            <input
              type="file"
              id="modalImageInput"
              accept="image/*"
              multiple
              (change)="onModalImageSelected($event)"
              class="hidden-file-input"
            />
            <label for="modalImageInput" class="custom-file-button">
              <i class="bi bi-image"></i> Add Image
            </label>
          </div>
          <button (click)="saveModalEdit()" class="buttons-container-save">
            Save
          </button>
          <button (click)="cancelModalEdit()" class="buttons-container-cancel">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add New Note Modal -->
  <div>
    <app-modal-add-new-note
      *ngIf="showAddNoteModal"
      (close)="closeNoteModal()"
    ></app-modal-add-new-note>
  </div>

  <!-- Create Notebook Modal -->
  <div>
    <app-modal-create-notebook
      *ngIf="showCreateNotebookModal"
      (close)="closeCreateNotebookModal()"
      (notebookCreated)="onNotebookCreated($event)"
    >
    </app-modal-create-notebook>
  </div>

  <!-- Add to Notebook Modal -->
  <div>
    <app-modal-add-to-notebook
      *ngIf="showAddToNotebookModal"
      [note]="noteToAddToNotebook"
      (close)="closeAddToNotebookModal()"
    ></app-modal-add-to-notebook>
  </div>

  <!-- Notebook Edit Modal -->
  <div
    class="notebook-edit-modal"
    *ngIf="editingNotebook"
    (click)="cancelNotebookEdit()"
  >
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>Edit Notebook</h3>
      <input [(ngModel)]="editingNotebookName" placeholder="Notebook Name" />
      <div class="edit-buttons">
        <button (click)="saveNotebookEdit()">Save</button>
        <button (click)="cancelNotebookEdit()">Cancel</button>
      </div>
    </div>
  </div>
</div>
